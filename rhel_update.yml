---
- name: "RHEL Server DNF Update and Upgrade"
  hosts: all
  become: yes  # Requires sudo privileges for dnf operations
  gather_facts: yes  # Gather facts to check OS version if needed
  vars:
    # Use pipelining to avoid SFTP/SCP transfer warnings
    ansible_pipelining: yes
    # Disable SSH connection transfer method warnings
    ansible_ssh_transfer_method: piped
    # Note: For Python interpreter warnings, set ansible_python_interpreter
    # in AWX inventory variables (e.g., /usr/bin/python3) per host/group

  tasks:
    - name: "Update dnf package cache"
      ansible.builtin.dnf:
        update_cache: yes

    - name: "Upgrade all packages to latest version"
      ansible.builtin.dnf:
        name: '*'
        state: latest

    - name: "Remove automatically installed packages that are no longer needed"
      ansible.builtin.dnf:
        autoremove: yes

    - name: "Clean dnf package cache"
      ansible.builtin.command:
        cmd: dnf clean all
      changed_when: false  # Cache cleaning doesn't change system state

